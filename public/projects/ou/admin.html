<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">
    <div id="app" class="h-full flex flex-col">
        
        <!-- Login Modal -->
        <transition name="modal">
            <div v-if="!isAuthenticated" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                <div class="bg-white rounded-lg shadow-xl p-8 w-96 max-w-full">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">管理员登录</h2>
                    <form @submit.prevent="login">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">用户名</label>
                            <input v-model="loginForm.username" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6 relative">
                            <label class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                            <input :type="showLoginPassword ? 'text' : 'password'" v-model="loginForm.password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <button type="button" @click="showLoginPassword = !showLoginPassword" class="absolute right-3 top-9 text-gray-500 hover:text-gray-700">
                                <i :class="showLoginPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="submit" :disabled="loading" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transition duration-300">
                                <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> 登录中...</span>
                                <span v-else>登 录</span>
                            </button>
                        </div>
                        <p v-if="loginError" class="text-red-500 text-xs italic mt-4 text-center">{{ loginError }}</p>
                    </form>
                </div>
            </div>
        </transition>

        <!-- Main Interface -->
        <div v-if="isAuthenticated" class="flex-1 flex overflow-hidden">
            <!-- Sidebar: Project List -->
            <aside class="w-80 bg-white shadow-md flex flex-col border-r border-gray-200 z-10">
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <h1 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-project-diagram mr-2 text-blue-600"></i> 项目管理
                    </h1>
                    <div class="flex space-x-2 mb-4">
                        <div class="relative flex-1">
                            <input v-model="searchQuery" type="text" placeholder="搜索项目..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <button @click="showAddProjectModal = true" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition" title="新增项目">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div v-if="loadingProjects" class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i> 加载项目中...
                    </div>
                    
                    <div v-for="project in filteredProjects" :key="project.name" 
                         @click="selectProject(project)"
                         class="p-3 rounded-lg cursor-pointer transition-colors duration-200 border border-transparent hover:border-blue-300 hover:bg-blue-50 group"
                         :class="{'bg-blue-100 border-blue-500': currentProject && currentProject.name === project.name}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-gray-800 truncate" :title="project.name">{{ project.name }}</span>
                            <div class="flex space-x-1">
                                <span v-if="project.is_published" class="text-green-500" title="已发布"><i class="fas fa-check-circle"></i></span>
                                <span v-if="project.is_encrypted" class="text-amber-500" title="已加密"><i class="fas fa-lock"></i></span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 truncate">{{ project.path }}</div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 bg-gray-50">
                    <button @click="fetchProjects" class="text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center w-full">
                        <i class="fas fa-sync-alt mr-2"></i> 刷新列表
                    </button>
                </div>
            </aside>

            <!-- Main Content: Editor -->
            <main class="flex-1 flex flex-col bg-gray-100 relative">
                <!-- Top Bar -->
                <header class="bg-white shadow-sm p-4 flex justify-between items-center h-16">
                    <div v-if="currentProject">
                        <h2 class="text-lg font-bold text-gray-800">{{ currentProject.name }}</h2>
                    </div>
                    <div v-else class="text-gray-500 italic">请选择一个项目开始编辑</div>
                    
                    <div class="flex space-x-3">
                         <button @click="showJsLibrary = true" class="px-4 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition">
                            <i class="fas fa-code mr-1"></i> JS 库
                        </button>
                        <button @click="showConfigModal = true" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                            <i class="fas fa-cog mr-1"></i> 全局设置
                        </button>
                    </div>
                </header>

                <!-- Editor Area -->
                <div v-if="currentProject" class="flex-1 overflow-y-auto p-6">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex border-b border-gray-200 mb-6">
                            <button v-for="tab in tabs" :key="tab.id"
                                    @click="currentTab = tab.id"
                                    class="py-2 px-4 font-medium text-sm focus:outline-none border-b-2 transition-colors duration-200"
                                    :class="currentTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                                {{ tab.name }}
                            </button>
                        </div>

                        <!-- Tab: Basic Settings -->
                        <div v-if="currentTab === 'settings'" class="space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">项目显示名称 (支持中文)</label>
                                    <input v-model="editForm.name" type="text" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">文件夹名称 (GitHub)</label>
                                    <input v-model="editForm.folderName" type="text" disabled class="w-full border rounded p-2 bg-gray-100 text-gray-500 cursor-not-allowed">
                                </div>
                            </div>
                            
                            <div class="flex space-x-8">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" v-model="editForm.is_public" class="form-checkbox h-5 w-5 text-blue-600">
                                    <span>在首页展示</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" v-model="editForm.is_encrypted" class="form-checkbox h-5 w-5 text-amber-600">
                                    <span>启用密码保护</span>
                                </label>
                            </div>

                            <div v-if="editForm.is_encrypted" class="bg-amber-50 p-4 rounded border border-amber-200 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-amber-800 mb-1">访问密码 (多个密码请用逗号分隔)</label>
                                    <div class="relative">
                                         <input :type="showEditPassword ? 'text' : 'password'" v-model="editForm.passwordsStr" class="w-full border border-amber-300 rounded p-2 focus:ring-2 focus:ring-amber-500">
                                         <button type="button" @click="showEditPassword = !showEditPassword" class="absolute right-3 top-2.5 text-amber-600 hover:text-amber-800">
                                            <i :class="showEditPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-amber-800 mb-1">记住密码时长 (天)</label>
                                    <input type="number" v-model="editForm.remember_duration" class="w-32 border border-amber-300 rounded p-2">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">相关文章链接 (选填)</label>
                                <input v-model="editForm.related_link" type="url" placeholder="https://..." class="w-full border rounded p-2">
                            </div>
                        </div>

                        <!-- Tab: Content & Files -->
                        <div v-if="currentTab === 'content'" class="space-y-6">
                            <!-- File Upload -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors bg-gray-50">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 mb-2">拖拽文件到此处或点击上传</p>
                                <input type="file" multiple @change="handleFileUpload" class="hidden" id="fileInput">
                                <label for="fileInput" class="px-4 py-2 bg-white border border-gray-300 rounded shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer">
                                    选择文件
                                </label>
                                <div v-if="uploadQueue.length > 0" class="mt-4 text-left max-w-md mx-auto">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">待上传文件:</h4>
                                    <ul class="text-sm space-y-1">
                                        <li v-for="file in uploadQueue" :key="file.name" class="flex justify-between">
                                            <span>{{ file.name }}</span>
                                            <button @click="removeFile(file)" class="text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Markdown Editor -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">Markdown 内容 (将保存为 content.md)</label>
                                    <button @click="toggleMdPreview" class="text-xs text-blue-600 hover:underline">
                                        {{ showMdPreview ? '编辑模式' : '预览模式' }}
                                    </button>
                                </div>
                                <div v-if="!showMdPreview">
                                    <textarea v-model="editForm.mdContent" rows="10" class="w-full border rounded p-2 font-mono text-sm bg-gray-50 focus:bg-white transition-colors" placeholder="# 项目标题..."></textarea>
                                </div>
                                <div v-else class="prose prose-sm max-w-none border rounded p-4 bg-white min-h-[200px]" v-html="renderedMd"></div>
                            </div>
                            
                            <!-- File Editor (Simple) -->
                            <div v-if="currentProject.is_published">
                                <h3 class="font-bold text-gray-700 mb-2 mt-6">现有文件编辑</h3>
                                <div class="flex space-x-2 mb-2">
                                    <input v-model="fileToEditPath" placeholder="输入文件路径 (如: index.html)" class="border rounded px-2 py-1 text-sm flex-1">
                                    <button @click="loadFileContent" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm">读取</button>
                                </div>
                                <div v-if="editingFileContent !== null" class="relative">
                                    <textarea v-model="editingFileContent" rows="10" class="w-full border rounded p-2 font-mono text-sm bg-gray-900 text-green-400"></textarea>
                                    <div class="absolute top-2 right-2">
                                        <button @click="saveFileContent" class="bg-blue-600 text-white px-3 py-1 rounded text-xs shadow hover:bg-blue-700">保存更改</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: JS Injection -->
                        <div v-if="currentTab === 'js'" class="space-y-4">
                            <p class="text-sm text-gray-500">勾选需要注入到此项目的 JS 库。这些脚本将在页面加载时自动运行。</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div v-for="lib in jsLibrary" :key="lib.id" 
                                     class="flex items-center p-3 border rounded hover:bg-gray-50 cursor-pointer"
                                     @click="toggleJsInjection(lib.id)">
                                    <input type="checkbox" :checked="editForm.js_injections.includes(lib.id)" class="h-4 w-4 text-blue-600 mr-3">
                                    <div>
                                        <div class="font-medium text-gray-800">{{ lib.name }}</div>
                                        <div class="text-xs text-gray-500 truncate">{{ lib.id }}</div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="jsLibrary.length === 0" class="text-center text-gray-400 py-4">
                                暂无 JS 库，请点击右上角“JS 库”按钮添加。
                            </div>
                        </div>
                        
                        <!-- Tab: Extra Buttons -->
                        <div v-if="currentTab === 'buttons'" class="space-y-4">
                             <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">自定义按钮</label>
                                <button @click="addExtraButton" class="text-sm text-blue-600"><i class="fas fa-plus"></i> 添加按钮</button>
                            </div>
                            
                            <div v-for="(btn, index) in editForm.extra_buttons" :key="index" class="border rounded p-4 bg-gray-50 relative">
                                <button @click="removeExtraButton(index)" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="text-xs text-gray-500">按钮文字</label>
                                        <input v-model="btn.label" class="w-full border rounded p-1 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">类型</label>
                                        <select v-model="btn.type" class="w-full border rounded p-1 text-sm">
                                            <option value="link">链接跳转</option>
                                            <option value="modal">弹窗内容</option>
                                        </select>
                                    </div>
                                </div>
                                <div v-if="btn.type === 'link'">
                                    <label class="text-xs text-gray-500">URL</label>
                                    <input v-model="btn.content" class="w-full border rounded p-1 text-sm">
                                </div>
                                <div v-if="btn.type === 'modal'">
                                    <label class="text-xs text-gray-500">弹窗内容 (支持 HTML/Markdown)</label>
                                    <textarea v-model="btn.content" rows="3" class="w-full border rounded p-1 text-sm"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex justify-end space-x-4 mb-10">
                         <button v-if="currentProject.is_published" @click="deleteProject" class="px-6 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                            <i class="fas fa-trash mr-2"></i> 删除项目
                        </button>
                        <button @click="saveProject" :disabled="saving" class="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition flex items-center">
                            <i v-if="saving" class="fas fa-spinner fa-spin mr-2"></i>
                            {{ saving ? '保存中...' : '发布 / 更新项目' }}
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- JS Library Modal -->
        <div v-if="showJsLibrary" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
            <div class="bg-white rounded-lg shadow-xl w-3/4 h-3/4 flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="font-bold text-lg">JavaScript 库管理</h3>
                    <button @click="showJsLibrary = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div class="w-1/3 border-r overflow-y-auto p-2 bg-gray-50">
                        <button @click="createNewJs" class="w-full mb-2 py-2 border-2 border-dashed border-gray-300 rounded text-gray-500 hover:border-blue-500 hover:text-blue-500">
                            + 新建脚本
                        </button>
                        <div class="mb-2">
                            <input type="file" id="jsUploadInput" accept=".js" class="hidden" @change="handleJsUpload">
                            <label for="jsUploadInput" class="w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-500 hover:border-green-500 hover:text-green-500 flex items-center justify-center cursor-pointer">
                                <i class="fas fa-file-upload mr-2"></i> 上传 JS 文件
                            </label>
                        </div>
                        <div v-for="lib in jsLibrary" :key="lib.id" 
                             @click="selectJsLib(lib)"
                             class="p-2 rounded cursor-pointer mb-1 hover:bg-white hover:shadow-sm"
                             :class="{'bg-white shadow-sm border-l-4 border-blue-500': currentJsLib && currentJsLib.id === lib.id}">
                            {{ lib.name }}
                        </div>
                    </div>
                    <div class="w-2/3 p-4 flex flex-col" v-if="currentJsLib">
                        <input v-model="currentJsLib.name" placeholder="脚本名称" class="mb-4 border rounded p-2 font-bold text-lg">
                        <textarea v-model="currentJsLib.content" class="flex-1 border rounded p-4 font-mono text-sm bg-gray-900 text-green-400 mb-4 resize-none" spellcheck="false"></textarea>
                        <div class="flex justify-between">
                            <button @click="deleteJsLib" class="text-red-500 hover:text-red-700">删除</button>
                            <button @click="saveJsLib" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">保存脚本</button>
                        </div>
                    </div>
                    <div class="w-2/3 flex items-center justify-center text-gray-400" v-else>
                        请选择或新建一个脚本
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Config Modal -->
        <div v-if="showConfigModal" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
             <div class="bg-white rounded-lg shadow-xl w-96 p-6">
                <h3 class="font-bold text-lg mb-4">全局设置</h3>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">每页展示项目数</label>
                        <input v-model="globalConfig.items_per_page" type="number" class="w-full border rounded p-2">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">网站标题</label>
                        <input v-model="globalConfig.site_title" type="text" class="w-full border rounded p-2">
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button @click="showConfigModal = false" class="px-4 py-2 text-gray-600 hover:bg-100 rounded">取消</button>
                    <button @click="saveGlobalConfig" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">保存</button>
                </div>
            </div>
        </div>

        <!-- Add Project Modal -->
        <div v-if="showAddProjectModal" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50">
             <div class="bg-white rounded-lg shadow-xl w-96 p-6">
                <h3 class="font-bold text-lg mb-4">新增项目</h3>
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">文件夹名称 (GitHub)</label>
                        <input v-model="newProjectForm.folderName" type="text" placeholder="例如: my-new-project" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-400 mt-1">仅限英文字母、数字和连字符</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">项目显示名称</label>
                        <input v-model="newProjectForm.name" type="text" placeholder="例如: 我的新项目" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button @click="showAddProjectModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                    <button @click="createNewProject" :disabled="loading" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                        <i v-if="loading" class="fas fa-spinner fa-spin mr-1"></i> 确认创建
                    </button>
                </div>
            </div>
        </div>

    </div>
    <script src="/assets/js/admin.js"></script>

<!-- Injected by Cloudflare Pages Admin -->

<script>
document.onkeydown=function(e){if(123==e.keyCode||(e.ctrlKey&&e.shiftKey&&(73==e.keyCode||74==e.keyCode))||(e.ctrlKey&&85==e.keyCode))return!1};
document.oncontextmenu=function(e){return!1};
(function(){try{var e=new Function("debugger");setInterval(e,1e3)}catch(e){}})();
</script>
</body>
</html>
