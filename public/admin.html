<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin ä¸“å±è¦†ç›– */
        body { background: #f1f5f9; }
        .dashboard-layout { display: grid; grid-template-columns: 250px 1fr; gap: 2rem; max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .sidebar { background: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); height: fit-content; }
        .main-content { }
        
        /* ç™»å½•å±‚ */
        #loginLayer { position: fixed; inset: 0; background: #f8fafc; z-index: 999; display: flex; align-items: center; justify-content: center; }
        
        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; color: var(--text-muted); }
        .action-btn:hover { background: #f1f5f9; color: var(--primary); }
        .action-btn.delete:hover { color: #ef4444; }
    </style>
</head>
<body>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginLayer">
        <div class="modal-box" style="width: 400px;">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">Admin Login</h2>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="uUser" class="form-input">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="uPass" class="form-input">
            </div>
            <button onclick="doLogin()" class="btn btn-primary" style="width: 100%;">Sign In</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainDashboard" style="display: none;">
        <nav class="navbar" style="position: static; margin-bottom: 2rem;">
            <div class="brand">System Admin</div>
            <div>
                <button onclick="openEditModal()" class="btn btn-primary">+ æ–°å¢é¡¹ç›®</button>
            </div>
        </nav>

        <div class="container">
            <div class="card-bg" style="background: white; border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem;">
                <div class="admin-header">
                    <h3>é¡¹ç›®åˆ—è¡¨ç®¡ç†</h3>
                    <button onclick="loadProjects()" class="btn btn-outline btn-sm">åˆ·æ–°æ•°æ®</button>
                </div>

                <table class="data-table" id="projectTable">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>çŠ¶æ€</th>
                            <th>è®¿é—®æƒé™</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                            <th style="text-align: right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody><!-- JS å¡«å…… --></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘/æ–°å¢ Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle" style="margin-bottom: 1.5rem;">æ–°å¢é¡¹ç›®</h3>
            <form id="uploadForm">
                <div class="form-group">
                    <label>æ–‡ä»¶å¤¹åç§° (ID)</label>
                    <input type="text" name="folderName" id="f_name" class="form-input" required pattern="[A-Za-z0-9\-_]+" placeholder="ä¾‹: react-demo">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">å”¯ä¸€æ ‡è¯†ï¼Œä¸å¯åŒ…å«ä¸­æ–‡æˆ–ç©ºæ ¼ã€‚</small>
                </div>

                <div class="form-group">
                    <label>é¡¹ç›®æ–‡ä»¶ (ä¸Šä¼ ä»¥è¦†ç›–ï¼Œç•™ç©ºåˆ™åªæ›´æ–°è®¾ç½®)</label>
                    <input type="file" name="files" id="f_files" class="form-input" multiple>
                </div>

                <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="isPublic" id="f_public" value="true" checked> åœ¨é¦–é¡µå±•ç¤º
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="isEncrypted" id="f_encrypted" value="true" onchange="togglePwd()"> åŠ å¯†é¡¹ç›®
                    </label>
                </div>

                <div id="pwdArea" class="hidden" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label>è®¿é—®å¯†ç  (é€—å·åˆ†éš”å¤šä¸ª)</label>
                        <input type="text" name="passwords" id="f_passwords" class="form-input" placeholder="123, abc">
                    </div>
                    <div class="form-group">
                        <label>ç›¸å…³æ–‡ç« é“¾æ¥</label>
                        <input type="url" name="articleLink" id="f_link" class="form-input" placeholder="https://...">
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" onclick="closeEditModal()" class="btn btn-outline">å–æ¶ˆ</button>
                    <button type="submit" id="btnSubmit" class="btn btn-primary">æäº¤ä¿å­˜</button>
                </div>
                <div id="statusMsg" style="margin-top: 1rem; text-align: center; font-size: 0.9rem;"></div>
            </form>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---

        // 1. åˆå§‹åŒ–
        window.onload = loadProjects;

        // 2. ç™»å½•
        async function doLogin() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            const res = await fetch('/api/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });
            if (res.ok && (await res.json()).success) {
                document.getElementById('loginLayer').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                loadProjects();
            } else { alert('Login Failed'); }
        }

        // 3. åŠ è½½åˆ—è¡¨
        let allProjects = []; // æœ¬åœ°ç¼“å­˜ç”¨äºå¡«å……è¡¨å•
        async function loadProjects() {
            const res = await fetch('/api/list');
            if (res.status === 401) {
                document.getElementById('loginLayer').style.display = 'flex';
                document.getElementById('mainDashboard').style.display = 'none';
                return;
            }
            document.getElementById('loginLayer').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';

            allProjects = await res.json();
            const tbody = document.querySelector('#projectTable tbody');
            tbody.innerHTML = '';
            
            allProjects.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight: 500;">${p.folder_name}</td>
                    <td><span class="status-badge ${p.is_public ? 'bg-green' : 'bg-gray'}">${p.is_public ? 'å·²å‘å¸ƒ' : 'éšè—'}</span></td>
                    <td>${p.is_encrypted ? 'ğŸ”’ åŠ å¯†' : 'ğŸŒ å…¬å¼€'}</td>
                    <td style="color: var(--text-muted); font-size: 0.85rem;">${new Date(p.updated_at).toLocaleString()}</td>
                    <td style="text-align: right;">
                        <button onclick="editProject('${p.folder_name}')" class="btn btn-outline btn-sm" style="margin-right: 5px;">ç¼–è¾‘</button>
                        <button onclick="deleteProject('${p.folder_name}')" class="btn btn-danger btn-sm">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. ç¼–è¾‘/æ–°å¢ Modal é€»è¾‘
        function openEditModal(mode = 'create', data = null) {
            const modal = document.getElementById('editModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('uploadForm');
            
            form.reset();
            document.getElementById('statusMsg').innerText = '';
            
            if (mode === 'edit' && data) {
                title.innerText = 'ç¼–è¾‘é¡¹ç›®é…ç½®';
                document.getElementById('f_name').value = data.folder_name;
                document.getElementById('f_name').readOnly = true; // ç¼–è¾‘æ—¶ä¸è®¸æ”¹ID
                document.getElementById('f_public').checked = !!data.is_public;
                document.getElementById('f_encrypted').checked = !!data.is_encrypted;
                
                const pwds = JSON.parse(data.passwords || '[]');
                document.getElementById('f_passwords').value = pwds.join(', ');
                document.getElementById('f_link').value = data.article_link || '';
                
                // æç¤ºç”¨æˆ·
                document.getElementById('f_files').required = false; // ç¼–è¾‘æ¨¡å¼æ–‡ä»¶å¯é€‰
            } else {
                title.innerText = 'æ–°å»ºé¡¹ç›®';
                document.getElementById('f_name').readOnly = false;
                document.getElementById('f_files').required = true; // æ–°å»ºå¿…é¡»ä¼ æ–‡ä»¶
            }
            
            togglePwd();
            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function editProject(folderName) {
            const p = allProjects.find(i => i.folder_name === folderName);
            if (p) openEditModal('edit', p);
        }

        function togglePwd() {
            const chk = document.getElementById('f_encrypted');
            document.getElementById('pwdArea').className = chk.checked ? '' : 'hidden';
        }

        // 5. æäº¤è¡¨å• (æ–°å¢æˆ–æ›´æ–°)
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const msg = document.getElementById('statusMsg');
            btn.disabled = true;
            btn.innerText = 'å¤„ç†ä¸­...';

            const formData = new FormData(e.target);
            if(!e.target.isPublic.checked) formData.set('isPublic', 'false');
            if(!e.target.isEncrypted.checked) formData.set('isEncrypted', 'false');

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    alert('æ“ä½œæˆåŠŸï¼');
                    closeEditModal();
                    loadProjects();
                } else {
                    msg.innerText = 'å¤±è´¥: ' + (result.message || 'Error');
                    msg.style.color = 'red';
                }
            } catch (err) {
                msg.innerText = 'ç½‘ç»œé”™è¯¯';
            } finally {
                btn.disabled = false;
                btn.innerText = 'æäº¤ä¿å­˜';
            }
        });

        // 6. åˆ é™¤é€»è¾‘
        async function deleteProject(folderName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${folderName}" å—ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†ä»å±•ç¤ºé¡µç§»é™¤ï¼Œä½† GitHub ä¸Šçš„æ–‡ä»¶å¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†ã€‚`)) return;

            try {
                const res = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ folderName })
                });
                if (res.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadProjects();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }
    </script>
</body>
</html>
