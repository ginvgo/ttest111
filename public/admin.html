<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é¡¹ç›®ç®¡ç†åå°</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- ================= ç™»å½•ç•Œé¢ ================= -->
    <div id="loginLayer" class="login-layer">
        <div class="login-card">
            <h2 style="text-align: center; margin-bottom: 2rem; color: var(--text-main);">ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="uUser" class="form-input" placeholder="Admin Username">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <div class="password-wrapper">
                    <input type="password" id="uPass" class="form-input" placeholder="Password">
                    <!-- çœ¼ç›å›¾æ ‡ -->
                    <span class="password-toggle" onclick="toggleLoginPassword()">
                        <svg id="eyeIcon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </span>
                </div>
            </div>
            <button onclick="doLogin()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">ç™» å½•</button>
        </div>
    </div>

    <!-- ================= ä¸»ç•Œé¢ (åŒæ ) ================= -->
    <div id="mainDashboard" class="hidden">
        <!-- é¡¶éƒ¨æ  -->
        <nav class="navbar">
            <div class="brand">
                <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                Console
            </div>
            <a href="/" target="_blank" class="btn btn-text">æŸ¥çœ‹é¦–é¡µ &rarr;</a>
        </nav>

        <div class="admin-layout">
            <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3 style="font-size: 0.95rem;">é¡¹ç›®åˆ—è¡¨</h3>
                    <button onclick="initCreateMode()" class="btn btn-primary btn-sm">+ æ–°å»º</button>
                </div>
                <div id="projectList" class="project-list">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨é¡¹ -->
                    <div style="text-align:center; padding: 2rem; color: #999;">åŠ è½½ä¸­...</div>
                </div>
            </aside>

            <!-- å³ä¾§ï¼šç¼–è¾‘è¡¨å• -->
            <main class="main-content">
                <div class="editor-card">
                    <div class="editor-header">
                        <h2 id="editorTitle">æ–°å»ºé¡¹ç›®</h2>
                        <button id="btnDelete" class="btn btn-danger btn-sm hidden" onclick="confirmDelete()">åˆ é™¤é¡¹ç›®</button>
                    </div>

                    <form id="uploadForm">
                        <div class="form-group">
                            <label>é¡¹ç›® ID (æ–‡ä»¶å¤¹åç§°)</label>
                            <input type="text" name="folderName" id="f_name" class="form-input" required pattern="[A-Za-z0-9\-_]+" placeholder="ä¾‹å¦‚: my-react-app">
                            <small style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; display:block;">å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹ã€‚</small>
                        </div>

                        <div class="form-group">
                            <label>é¡¹ç›®æ–‡ä»¶ <span id="fileHint" style="font-weight: normal; color: var(--primary);"></span></label>
                            <input type="file" name="files" id="f_files" class="form-input" multiple>
                            <small style="color: var(--text-muted); font-size: 0.8rem;">ä¸Šä¼  index.html åŠç›¸å…³èµ„æºã€‚æ”¯æŒæ‹–æ‹½é€‰æ‹©ã€‚</small>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid var(--border);">
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" name="isPublic" id="f_public" value="true" checked style="margin-right: 8px;">
                                    åœ¨é¦–é¡µå±•ç¤º
                                </label>
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid var(--border);">
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" name="isEncrypted" id="f_encrypted" value="true" onchange="togglePwdArea()" style="margin-right: 8px;">
                                    å¼€å¯è®¿é—®å¯†ç 
                                </label>
                            </div>
                        </div>

                        <div id="pwdArea" class="hidden" style="background: #eff6ff; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem; border: 1px solid #bfdbfe;">
                            <div class="form-group">
                                <label>è®¿é—®å¯†ç  (æ”¯æŒå¤šä¸ªï¼Œé€—å·åˆ†éš”)</label>
                                <input type="text" name="passwords" id="f_passwords" class="form-input" placeholder="ä¾‹: 123, admin">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>ç›¸å…³æ–‡ç« é“¾æ¥ (å¯é€‰)</label>
                                <input type="url" name="articleLink" id="f_link" class="form-input" placeholder="https://...">
                            </div>
                        </div>

                        <div style="text-align: right; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                            <button type="submit" id="btnSubmit" class="btn btn-primary" style="padding-left: 2rem; padding-right: 2rem;">ä¿å­˜å¹¶å‘å¸ƒ</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- ================= è‡ªå®šä¹‰ç»„ä»¶å®¹å™¨ ================= -->
    
    <!-- 1. Toast å®¹å™¨ -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- 2. ç¡®è®¤åˆ é™¤å¼¹çª— -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">ç¡®è®¤åˆ é™¤?</h3>
            <p class="modal-desc" id="confirmText">åˆ é™¤åæ— æ³•æ¢å¤ã€‚</p>
            <div class="modal-actions">
                <button onclick="closeConfirmModal()" class="btn btn-outline">å–æ¶ˆ</button>
                <button id="btnConfirmAction" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // ============ å…¨å±€å˜é‡ ============
        let allProjects = [];
        let currentEditingId = null;

        // ============ åˆå§‹åŒ– ============
        window.onload = function() {
            // å°è¯•ç›´æ¥åŠ è½½ï¼ŒéªŒè¯ Session
            loadProjects();
        };

        // ============ 1. ç™»å½•é€»è¾‘ & å¯†ç åˆ‡æ¢ ============
        function toggleLoginPassword() {
            const input = document.getElementById('uPass');
            const icon = document.getElementById('eyeIcon');
            if (input.type === 'password') {
                input.type = 'text';
                // ç®€å•çš„æ–œçº¿å›¾æ ‡è·¯å¾„
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>';
            } else {
                input.type = 'password';
                // æ¢å¤æ­£å¸¸çœ¼ç›
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
            }
        }

        async function doLogin() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            if(!u || !p) return showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    document.getElementById('loginLayer').classList.add('hidden');
                    document.getElementById('mainDashboard').classList.remove('hidden');
                    showToast('ç™»å½•æˆåŠŸ', 'success');
                    loadProjects();
                } else {
                    showToast('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
                }
            } catch(e) { showToast('ç½‘ç»œè¿æ¥é”™è¯¯', 'error'); }
        }

        // ============ 2. åˆ—è¡¨ä¸æ•°æ®åŠ è½½ ============
        async function loadProjects() {
            const res = await fetch('/api/list');
            if (res.status === 401) {
                document.getElementById('loginLayer').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
                return;
            }
            
            // ç™»å½•æˆåŠŸ
            document.getElementById('loginLayer').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            allProjects = await res.json();
            renderList();
            
            // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­ï¼Œé»˜è®¤è¿›å…¥æ–°å»ºæ¨¡å¼
            if (!currentEditingId) initCreateMode();
        }

        function renderList() {
            const listEl = document.getElementById('projectList');
            listEl.innerHTML = '';
            
            if (allProjects.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:1rem; color:#999; font-size:0.9rem;">æš‚æ— é¡¹ç›®</div>';
                return;
            }

            allProjects.forEach(p => {
                const isEncrypted = p.is_encrypted === 1;
                const isPublic = p.is_public === 1;
                const isActive = p.folder_name === currentEditingId;

                const item = document.createElement('div');
                item.className = `list-item ${isActive ? 'active' : ''}`;
                item.onclick = () => selectProject(p.folder_name);
                
                item.innerHTML = `
                    <div class="item-title">
                        <span>${p.folder_name}</span>
                        ${isEncrypted ? 'ğŸ”’' : ''}
                    </div>
                    <div class="item-meta">
                        <span class="status-dot ${isPublic ? 'dot-green' : 'dot-gray'}"></span>
                        ${isPublic ? 'å·²å‘å¸ƒ' : 'å·²éšè—'}
                        <span style="margin-left:auto;">${new Date(p.updated_at).toLocaleDateString()}</span>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        // ============ 3. è¡¨å•é€»è¾‘ (æ–°å»º/ç¼–è¾‘) ============
        
        function initCreateMode() {
            currentEditingId = null;
            renderList(); // ç§»é™¤åˆ—è¡¨é€‰ä¸­æ€
            
            document.getElementById('editorTitle').innerText = 'æ–°å»ºé¡¹ç›®';
            document.getElementById('btnDelete').classList.add('hidden');
            
            // é‡ç½®è¡¨å•
            const form = document.getElementById('uploadForm');
            form.reset();
            
            // æ¢å¤æ§ä»¶çŠ¶æ€
            document.getElementById('f_name').readOnly = false;
            document.getElementById('f_name').value = '';
            document.getElementById('fileHint').innerText = '(å¿…é¡»ä¸Šä¼ )';
            document.getElementById('f_files').required = true;
            
            togglePwdArea();
        }

        function selectProject(id) {
            currentEditingId = id;
            renderList(); // æ›´æ–°é«˜äº®

            const p = allProjects.find(x => x.folder_name === id);
            if (!p) return;

            // å¡«å……è¡¨å•
            document.getElementById('editorTitle').innerText = 'ç¼–è¾‘é¡¹ç›®';
            document.getElementById('btnDelete').classList.remove('hidden');

            document.getElementById('f_name').value = p.folder_name;
            document.getElementById('f_name').readOnly = true; // ç¼–è¾‘ä¸å¯æ”¹ID

            document.getElementById('f_public').checked = !!p.is_public;
            document.getElementById('f_encrypted').checked = !!p.is_encrypted;
            
            const pwds = JSON.parse(p.passwords || '[]');
            document.getElementById('f_passwords').value = pwds.join(', ');
            document.getElementById('f_link').value = p.article_link || '';

            document.getElementById('fileHint').innerText = '(å¯é€‰: ä¸Šä¼ ä»¥è¦†ç›–)';
            document.getElementById('f_files').required = false;

            togglePwdArea();
        }

        function togglePwdArea() {
            const chk = document.getElementById('f_encrypted');
            const area = document.getElementById('pwdArea');
            if (chk.checked) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        // ============ 4. æäº¤ä¿å­˜ ============
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨ä¿å­˜...';

            const formData = new FormData(e.target);
            if(!e.target.isPublic.checked) formData.set('isPublic', 'false');
            if(!e.target.isEncrypted.checked) formData.set('isEncrypted', 'false');

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                
                if (res.ok) {
                    showToast('ä¿å­˜æˆåŠŸ!', 'success');
                    // é‡æ–°è·å–åˆ—è¡¨ï¼Œä¿ç•™é€‰ä¸­çŠ¶æ€
                    const savedId = formData.get('folderName');
                    await loadProjects();
                    selectProject(savedId); 
                } else {
                    showToast('å¤±è´¥: ' + (result.message || 'Error'), 'error');
                }
            } catch (err) {
                showToast('ç½‘ç»œè¯·æ±‚é”™è¯¯', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'ä¿å­˜å¹¶å‘å¸ƒ';
            }
        });

        // ============ 5. åˆ é™¤é€»è¾‘ (è‡ªå®šä¹‰å¼¹çª—) ============
        function confirmDelete() {
            if (!currentEditingId) return;
            openConfirmModal(
                `ç¡®å®šè¦åˆ é™¤é¡¹ç›® "${currentEditingId}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`, 
                async () => {
                    try {
                        const res = await fetch('/api/delete', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ folderName: currentEditingId })
                        });
                        if (res.ok) {
                            showToast('åˆ é™¤æˆåŠŸ', 'success');
                            initCreateMode();
                            loadProjects();
                        } else {
                            showToast('åˆ é™¤å¤±è´¥', 'error');
                        }
                    } catch (e) { showToast('è¯·æ±‚å‡ºé”™', 'error'); }
                }
            );
        }

        // ============ 6. è‡ªå®šä¹‰ç»„ä»¶å®ç° ============
        
        // Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Confirm Modal
        let confirmCallback = null;
        function openConfirmModal(text, onConfirm) {
            document.getElementById('confirmText').innerText = text;
            document.getElementById('confirmModal').classList.add('active');
            confirmCallback = onConfirm;
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        }
        // ç»‘å®šåˆ é™¤ç¡®è®¤æŒ‰é’®
        document.getElementById('btnConfirmAction').onclick = function() {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        };

    </script>
</body>
</html>
