<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        
        /* ç™»å½•é®ç½©å±‚ï¼šé»˜è®¤æ˜¾ç¤º (å»æ‰ hidden)ï¼Œå±‚çº§æœ€é«˜ï¼Œå…¨å±ç™½è‰²èƒŒæ™¯ */
        #loginLayer { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 999;
        }

        /* ä¸»ç•Œé¢å®¹å™¨ï¼šé»˜è®¤éšè— */
        #mainDashboard { display: none; }

        /* é€šç”¨æ ·å¼ */
        .hidden { display: none !important; }
        .panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        form label { display: block; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

    <!-- 1. ç™»å½•å¼¹çª— (é»˜è®¤æ˜¾ç¤ºï¼Œæ²¡æœ‰ hidden ç±») -->
    <div id="loginLayer">
        <div style="text-align: center; border: 1px solid #ccc; padding: 40px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            <input type="text" id="uUser" placeholder="ç”¨æˆ·å" style="padding: 8px; margin-bottom: 10px; width: 200px;"><br>
            <input type="password" id="uPass" placeholder="å¯†ç " style="padding: 8px; margin-bottom: 20px; width: 200px;"><br>
            <button onclick="doLogin()" style="padding: 8px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px;">ç™»å½•</button>
        </div>
    </div>

    <!-- 2. ä¸»ç•Œé¢ (ç”¨ div åŒ…è£¹ï¼Œé»˜è®¤ display: none) -->
    <div id="mainDashboard">
        <h1>é¡¹ç›®ç®¡ç†åå°</h1>
        
        <div class="panel">
            <!-- å·¦ä¾§ï¼šå‘å¸ƒè¡¨å• -->
            <div class="card">
                <h2>å‘å¸ƒ/æ›´æ–°é¡¹ç›®</h2>
                <form id="uploadForm">
                    <label>æ–‡ä»¶å¤¹åç§° (è‹±æ–‡/æ•°å­—):
                        <input type="text" name="folderName" required pattern="[A-Za-z0-9\-_]+">
                    </label>
                    <label>ä¸Šä¼ æ–‡ä»¶ (index.html, css, jsç­‰):
                        <input type="file" name="files" multiple required>
                    </label>
                    <label>
                        <input type="checkbox" name="isPublic" value="true" checked> åœ¨é¦–é¡µå±•ç¤º
                    </label>
                    <label>
                        <input type="checkbox" name="isEncrypted" id="chkEncrypted" value="true" onchange="togglePwd()"> éœ€è¦å¯†ç è®¿é—®
                    </label>
                    <div id="pwdArea" class="hidden">
                        <label>è®¿é—®å¯†ç  (å¤šä¸ªç”¨é€—å·éš”å¼€):
                            <input type="text" name="passwords">
                        </label>
                        <label>ç›¸å…³æ–‡ç« é“¾æ¥:
                            <input type="url" name="articleLink">
                        </label>
                    </div>
                    <br>
                    <button type="submit" id="btnSubmit">æäº¤å¹¶å‘å¸ƒ</button>
                    <div id="statusMsg"></div>
                </form>
            </div>

            <!-- å³ä¾§ï¼šé¡¹ç›®åˆ—è¡¨ -->
            <div class="card">
                <h2>ç°æœ‰é¡¹ç›®åˆ—è¡¨</h2>
                <button onclick="loadProjects()">åˆ·æ–°åˆ—è¡¨</button>
                <table id="projectTable">
                    <thead><tr><th>åç§°</th><th>çŠ¶æ€</th><th>åŠ å¯†</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è·å–åˆ—è¡¨ï¼ŒéªŒè¯æ˜¯å¦å·²ç™»å½•
        window.onload = function() {
            loadProjects();
        };

        async function doLogin() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    // ç™»å½•æˆåŠŸï¼šéšè—å¼¹çª—ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢ï¼ŒåŠ è½½æ•°æ®
                    document.getElementById('loginLayer').classList.add('hidden');
                    document.getElementById('mainDashboard').style.display = 'block';
                    loadProjects();
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ç™»å½•è¯·æ±‚å‡ºé”™');
            }
        }

        function togglePwd() {
            const chk = document.getElementById('chkEncrypted');
            document.getElementById('pwdArea').className = chk.checked ? '' : 'hidden';
        }

        async function loadProjects() {
            // è°ƒç”¨å—ä¿æŠ¤çš„ API
            const res = await fetch('/api/list');
            
            // å…³é”®é€»è¾‘ï¼šå¦‚æœ API è¿”å› 401ï¼Œè¯´æ˜æœªç™»å½•ï¼Œä¿æŒå¼¹çª—æ˜¾ç¤º
            if (res.status === 401 || res.status === 403) {
                 document.getElementById('loginLayer').classList.remove('hidden');
                 document.getElementById('mainDashboard').style.display = 'none';
                 return;
            }

            // å¦‚æœ API æˆåŠŸï¼Œè¯´æ˜å·²ç™»å½•ï¼ˆæˆ–è€…æ˜¯ä¹‹å‰çš„ Cookie æœ‰æ•ˆï¼‰
            if (res.ok) {
                const data = await res.json();
                
                // åˆ‡æ¢ç•Œé¢æ˜¾ç¤º
                document.getElementById('loginLayer').classList.add('hidden');
                document.getElementById('mainDashboard').style.display = 'block';

                // æ¸²æŸ“è¡¨æ ¼
                const tbody = document.querySelector('#projectTable tbody');
                tbody.innerHTML = '';
                data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.folder_name}</td>
                        <td>${p.is_public ? 'âœ…' : 'âŒ'}</td>
                        <td>${p.is_encrypted ? 'ğŸ”’' : 'ğŸ”“'}</td>
                        <td><button onclick="fillForm('${p.folder_name}')">æ›´æ–°</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function fillForm(name) {
            document.querySelector('[name="folderName"]').value = name;
            alert('é¡¹ç›® ' + name + ' å·²é€‰ä¸­ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶ä»¥è¦†ç›–ã€‚');
        }

        // ä¸Šä¼ è¡¨å•é€»è¾‘
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const msg = document.getElementById('statusMsg');
            btn.disabled = true;
            msg.innerText = 'æ­£åœ¨ä¸Šä¼ åˆ° GitHub å¹¶æ›´æ–°æ•°æ®åº“...';
            msg.style.color = 'blue';

            const formData = new FormData(e.target);
            if(!e.target.isPublic.checked) formData.set('isPublic', 'false');
            if(!e.target.isEncrypted.checked) formData.set('isEncrypted', 'false');

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    msg.innerText = 'å‘å¸ƒæˆåŠŸï¼';
                    msg.style.color = 'green';
                    loadProjects(); // åˆ·æ–°åˆ—è¡¨
                    e.target.reset(); // é‡ç½®è¡¨å•
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (err) {
                msg.innerText = 'é”™è¯¯: ' + err.message;
                msg.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
