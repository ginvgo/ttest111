<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; }
        .hidden { display: none !important; }
        .panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        form label { display: block; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    </style>
</head>
<body>

    <!-- ç™»å½•å±‚ -->
    <div id="loginLayer" class="login-overlay">
        <div>
            <h2>Admin Login</h2>
            <input type="text" id="uUser" placeholder="Username"><br><br>
            <input type="password" id="uPass" placeholder="Password"><br><br>
            <button onclick="doLogin()">Login</button>
        </div>
    </div>

    <h1>é¡¹ç›®ç®¡ç†åå°</h1>
    
    <div class="panel">
        <!-- å·¦ä¾§ï¼šå‘å¸ƒè¡¨å• -->
        <div class="card">
            <h2>å‘å¸ƒ/æ›´æ–°é¡¹ç›®</h2>
            <form id="uploadForm">
                <label>æ–‡ä»¶å¤¹åç§° (è‹±æ–‡/æ•°å­—):
                    <input type="text" name="folderName" required pattern="[A-Za-z0-9\-_]+">
                </label>
                
                <label>ä¸Šä¼ æ–‡ä»¶ (index.html, css, jsç­‰):
                    <input type="file" name="files" multiple required>
                </label>

                <label>
                    <input type="checkbox" name="isPublic" value="true" checked> åœ¨é¦–é¡µå±•ç¤º
                </label>

                <label>
                    <input type="checkbox" name="isEncrypted" id="chkEncrypted" value="true" onchange="togglePwd()"> éœ€è¦å¯†ç è®¿é—®
                </label>

                <div id="pwdArea" class="hidden">
                    <label>è®¿é—®å¯†ç  (å¤šä¸ªç”¨é€—å·éš”å¼€):
                        <input type="text" name="passwords">
                    </label>
                    <label>ç›¸å…³æ–‡ç« é“¾æ¥:
                        <input type="url" name="articleLink">
                    </label>
                </div>

                <br>
                <button type="submit" id="btnSubmit">æäº¤å¹¶å‘å¸ƒ</button>
                <div id="statusMsg"></div>
            </form>
        </div>

        <!-- å³ä¾§ï¼šé¡¹ç›®åˆ—è¡¨ -->
        <div class="card">
            <h2>ç°æœ‰é¡¹ç›®åˆ—è¡¨</h2>
            <button onclick="loadProjects()">åˆ·æ–°åˆ—è¡¨</button>
            <table id="projectTable">
                <thead><tr><th>åç§°</th><th>çŠ¶æ€</th><th>åŠ å¯†</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. ç™»å½•é€»è¾‘
        async function doLogin() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: u, password: p })
            });
            if (res.ok) {
                document.getElementById('loginLayer').classList.add('hidden');
                loadProjects();
            } else {
                alert('Login Failed');
            }
        }

        function togglePwd() {
            const chk = document.getElementById('chkEncrypted');
            const area = document.getElementById('pwdArea');
            area.className = chk.checked ? '' : 'hidden';
        }

        // 2. åŠ è½½åˆ—è¡¨
        async function loadProjects() {
            const res = await fetch('/api/list');
            if (res.status === 401 || res.status === 403) {
                 document.getElementById('loginLayer').classList.remove('hidden');
                 return;
            }
            const data = await res.json();
            const tbody = document.querySelector('#projectTable tbody');
            tbody.innerHTML = '';
            data.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.folder_name}</td>
                    <td>${p.is_public ? 'å±•ç¤º' : 'éšè—'}</td>
                    <td>${p.is_encrypted ? 'ğŸ”' : 'ğŸ”“'}</td>
                    <td><button onclick="fillForm('${p.folder_name}')">æ›´æ–°</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function fillForm(name) {
            document.querySelector('[name="folderName"]').value = name;
            alert('è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶è¿›è¡Œè¦†ç›–ä¸Šä¼ ï¼Œå¹¶æ£€æŸ¥å¯†ç è®¾ç½®ã€‚');
        }

        // 3. ä¸Šä¼ é€»è¾‘
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const msg = document.getElementById('statusMsg');
            btn.disabled = true;
            msg.innerText = 'Uploading to GitHub & Updating D1...';

            const formData = new FormData(e.target);
            // å¤„ç† Checkbox
            if(!e.target.isPublic.checked) formData.set('isPublic', 'false');
            if(!e.target.isEncrypted.checked) formData.set('isEncrypted', 'false');

            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    msg.innerText = 'Success!';
                    loadProjects();
                    e.target.reset();
                } else {
                    throw new Error(result.message || 'Error');
                }
            } catch (err) {
                msg.innerText = 'Failed: ' + err.message;
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
