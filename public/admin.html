<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目管理后台</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --sidebar-width: 280px; }
        body { background: #f8fafc; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Login Layer */
        .login-layer { position: fixed; inset: 0; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; width: 400px; padding: 2.5rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }

        /* Dashboard Layout */
        .navbar { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; flex-shrink: 0; }
        .brand { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; color: #0f172a; }
        
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 1rem; border-bottom: 1px solid #f1f5f9; }
        .project-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .project-item { padding: 0.75rem 1rem; margin-bottom: 4px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s; border: 1px solid transparent; }
        .project-item:hover { background: #f1f5f9; }
        .project-item.active { background: #eff6ff; border-color: #bfdbfe; color: #2563eb; }
        .project-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 6px; color: #64748b; font-size: 14px; }
        .project-info { flex: 1; overflow: hidden; }
        .project-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-id { font-size: 0.75rem; color: #94a3b8; }
        .pagination { padding: 1rem; border-top: 1px solid #f1f5f9; display: flex; justify-content: center; gap: 5px; }
        .page-btn { padding: 4px 8px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Editor Area */
        .editor-area { flex: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; }
        .editor-card { background: white; max-width: 900px; margin: 0 auto; padding: 2rem; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #f1f5f9; }
        
        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: #334155; }
        .form-input { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.95rem; transition: border-color 0.2s; }
        .form-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; }
        
        /* Extra Buttons Config */
        .btn-config-list { display: flex; flex-direction: column; gap: 10px; }
        .btn-config-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; position: relative; }
        .btn-remove { position: absolute; top: 10px; right: 10px; color: #ef4444; cursor: pointer; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 5000; }
        .toast { background: #333; color: white; padding: 12px 24px; border-radius: 6px; margin-top: 10px; animation: slideIn 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="loginLayer" class="login-layer">
        <div class="login-card">
            <h2 style="text-align: center; margin-bottom: 1.5rem; color: #0f172a;">管理后台登录</h2>
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="uUser" class="form-input" placeholder="Admin Username">
            </div>
            <div class="form-group">
                <label>密码</label>
                <div class="password-wrapper">
                    <input type="password" id="uPass" class="form-input" placeholder="Password">
                    <span class="password-toggle" onclick="togglePwd('uPass', this)"><i class="fa-regular fa-eye"></i></span>
                </div>
            </div>
            <button onclick="doLogin()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">登 录</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <nav class="navbar">
            <div class="brand">
                <i class="fa-solid fa-layer-group"></i> 项目管理控制台
            </div>
            <a href="/" target="_blank" class="btn btn-text">预览首页 <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
        </nav>

        <div class="main-container">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <button onclick="initCreate()" class="btn btn-primary" style="width: 100%;"><i class="fa-solid fa-plus"></i> 新建项目</button>
                </div>
                <div id="projectList" class="project-list">
                    <!-- Loaded via JS -->
                </div>
                <div class="pagination">
                    <button id="prevPage" class="page-btn" onclick="changePage(-1)">&lt;</button>
                    <span id="pageInfo" style="font-size: 0.8rem; align-self: center; color: #64748b;">1 / 1</span>
                    <button id="nextPage" class="page-btn" onclick="changePage(1)">&gt;</button>
                </div>
            </aside>

            <!-- Editor -->
            <main class="editor-area">
                <div class="editor-card">
                    <div class="editor-header">
                        <h2 id="editorTitle">新建项目</h2>
                        <button id="btnDelete" class="btn btn-danger btn-sm hidden" onclick="deleteProject()">删除项目</button>
                    </div>

                    <form id="projectForm" onsubmit="return false;">
                        <!-- 核心信息 -->
                        <div class="grid-2">
                            <div class="form-group">
                                <label>项目 ID (URL路径, 不可改)</label>
                                <input type="text" id="f_folderName" class="form-input" required pattern="[a-zA-Z0-9\-_]+" placeholder="例如: demo-01">
                            </div>
                            <div class="form-group">
                                <label>显示名称</label>
                                <input type="text" id="f_projectName" class="form-input" required placeholder="例如: 产品演示">
                            </div>
                        </div>

                        <!-- 图标 -->
                        <div class="form-group">
                            <label>图标 (FontAwesome 类名 或 图片URL)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="f_iconUrl" class="form-input" placeholder="fa-solid fa-rocket" oninput="previewIcon()">
                                <div id="iconPreview" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 6px; font-size: 1.2rem; color: #3b82f6; flex-shrink: 0;">
                                    <i class="fa-solid fa-cube"></i>
                                </div>
                            </div>
                        </div>

                        <!-- 文件上传 -->
                        <div class="form-group">
                            <label>项目文件 (index.html, css, js...)</label>
                            <input type="file" id="f_files" class="form-input" multiple>
                            <small style="color: #64748b;">支持多选。如果包含 index.html，系统将自动注入保护脚本。</small>
                        </div>

                        <!-- 访问控制 -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; margin-bottom: 1rem; color: #334155;"><i class="fa-solid fa-shield-halved"></i> 访问控制</h3>
                            <div class="form-group">
                                <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="f_isPublic" checked> 在首页公开展示
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="f_isEncrypted" onchange="togglePwdArea()"> 启用密码保护
                                </label>
                            </div>
                            
                            <div id="pwdArea" class="hidden" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                                <div class="form-group">
                                    <label>访问密码 (多个密码用英文逗号分隔)</label>
                                    <input type="text" id="f_passwords" class="form-input" placeholder="123456, admin">
                                </div>
                                <div class="form-group">
                                    <label>免登有效期 (天)</label>
                                    <input type="number" id="f_rememberDays" class="form-input" value="30" min="1" max="365">
                                </div>
                            </div>
                        </div>

                        <!-- 额外按钮 -->
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <label>额外功能按钮 (弹窗/链接)</label>
                                <button type="button" class="btn btn-outline btn-sm" onclick="addExtraBtn()">+ 添加按钮</button>
                            </div>
                            <div id="extraBtnList" class="btn-config-list"></div>
                        </div>

                        <div style="margin-top: 2rem; text-align: right;">
                            <button type="button" onclick="submitForm()" class="btn btn-primary" style="padding: 0.8rem 2rem;">保存项目</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- Template for Extra Button Item -->
    <template id="tplBtnItem">
        <div class="btn-config-item">
            <i class="fa-solid fa-trash btn-remove" onclick="removeExtraBtn(this)"></i>
            <div class="grid-2">
                <div class="form-group">
                    <label>按钮名称</label>
                    <input type="text" class="form-input btn-label" placeholder="例如: 查看文档">
                </div>
                <div class="form-group">
                    <label>图标 (FontAwesome)</label>
                    <input type="text" class="form-input btn-icon" placeholder="fa-solid fa-book">
                </div>
            </div>
            <div class="form-group">
                <label>类型</label>
                <select class="form-input btn-type" onchange="toggleBtnContent(this)">
                    <option value="link">外部链接 (跳转)</option>
                    <option value="text">文本弹窗 (支持 Markdown)</option>
                    <option value="image">图片弹窗</option>
                </select>
            </div>
            <div class="form-group btn-content-group">
                <label class="content-label">链接地址</label>
                <textarea class="form-input btn-content" rows="3" placeholder="https://..."></textarea>
            </div>
        </div>
    </template>

    <script>
        // State
        let currentPage = 1;
        let totalPages = 1;
        let currentFolder = null; // null means create mode

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Check session loosely or just show login
            // For security, real check happens on API calls
            if(localStorage.getItem('admin_login')) {
                showDashboard();
            }
        });

        // --- Login ---
        async function doLogin() {
            const u = document.getElementById('uUser').value;
            const p = document.getElementById('uPass').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ username: u, password: p }),
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('admin_login', '1');
                    showDashboard();
                } else {
                    alert('登录失败: ' + (data.message || '未知错误'));
                }
            } catch(e) { alert('网络错误'); }
        }

        function showDashboard() {
            document.getElementById('loginLayer').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            loadProjects();
        }

        function togglePwd(id, el) {
            const input = document.getElementById(id);
            if (input.type === 'password') {
                input.type = 'text';
                el.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                el.innerHTML = '<i class="fa-regular fa-eye"></i>';
            }
        }

        // --- Projects List ---
        async function loadProjects(page = 1) {
            try {
                const res = await fetch(`/api/list?page=${page}&pageSize=20`); // Larger page size for admin
                const data = await res.json();
                
                currentPage = data.page;
                totalPages = data.totalPages || 1;
                
                renderList(data.items);
                updatePagination();
            } catch(e) { console.error(e); showToast('加载列表失败'); }
        }

        function renderList(items) {
            const container = document.getElementById('projectList');
            container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = `project-item ${currentFolder === item.folder_name ? 'active' : ''}`;
                div.onclick = () => loadProjectDetails(item);
                
                // Icon
                let iconHtml = '<i class="fa-solid fa-folder"></i>';
                if (item.icon_url) {
                    if (item.icon_url.startsWith('http')) {
                        iconHtml = `<img src="${item.icon_url}" style="width:20px;height:20px;object-fit:cover;">`;
                    } else if (item.icon_url.startsWith('fa-')) {
                        iconHtml = `<i class="${item.icon_url}"></i>`;
                    }
                }

                div.innerHTML = `
                    <div class="project-icon">${iconHtml}</div>
                    <div class="project-info">
                        <div class="project-name">${item.project_name}</div>
                        <div class="project-id">${item.folder_name}</div>
                    </div>
                    ${item.is_encrypted ? '<i class="fa-solid fa-lock" style="font-size:12px;color:#94a3b8;"></i>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function updatePagination() {
            document.getElementById('pageInfo').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) loadProjects(newPage);
        }

        // --- Editor ---
        function initCreate() {
            currentFolder = null;
            document.getElementById('editorTitle').innerText = '新建项目';
            document.getElementById('btnDelete').classList.add('hidden');
            document.getElementById('projectForm').reset();
            document.getElementById('f_folderName').disabled = false;
            document.getElementById('extraBtnList').innerHTML = '';
            document.getElementById('pwdArea').classList.add('hidden');
            document.getElementById('iconPreview').innerHTML = '<i class="fa-solid fa-cube"></i>';
            
            // Clear active state in list
            document.querySelectorAll('.project-item').forEach(el => el.classList.remove('active'));
        }

        function loadProjectDetails(item) {
            currentFolder = item.folder_name;
            document.getElementById('editorTitle').innerText = '编辑项目';
            document.getElementById('btnDelete').classList.remove('hidden');
            
            // Fill Form
            document.getElementById('f_folderName').value = item.folder_name;
            document.getElementById('f_folderName').disabled = true;
            document.getElementById('f_projectName').value = item.project_name;
            document.getElementById('f_iconUrl').value = item.icon_url || '';
            previewIcon();
            
            document.getElementById('f_isPublic').checked = item.is_public;
            document.getElementById('f_isEncrypted').checked = item.is_encrypted;
            togglePwdArea();
            
            // Passwords? API doesn't return passwords in list usually for security.
            // If we want to edit passwords, we might need a separate fetch or rely on what's returned.
            // list.js DOES NOT return passwords. We need to fetch details or just leave blank to keep unchanged.
            // For now, let's assume if user wants to change password, they enter new ones.
            // Or we can modify list.js to return passwords for admin.
            // Let's modify list.js to return passwords ONLY if admin. 
            // Wait, list.js already checks admin.
            // I'll leave password blank. If user enters nothing, we don't update it in upload.js? 
            // upload.js logic: `passwords = JSON.stringify(...)`. If empty string is sent, it becomes "[]".
            // We need a way to say "don't change".
            // Actually, for this simple system, maybe just ask admin to re-enter if they want to change.
            // OR, I can fetch specific project details.
            
            document.getElementById('f_rememberDays').value = item.remember_days || 30;
            
            // Extra Buttons
            const container = document.getElementById('extraBtnList');
            container.innerHTML = '';
            if (item.extra_buttons) {
                try {
                    const btns = JSON.parse(item.extra_buttons);
                    btns.forEach(b => addExtraBtn(b));
                } catch(e) {}
            }
        }

        function togglePwdArea() {
            const chk = document.getElementById('f_isEncrypted');
            const area = document.getElementById('pwdArea');
            if (chk.checked) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        function previewIcon() {
            const val = document.getElementById('f_iconUrl').value;
            const div = document.getElementById('iconPreview');
            if (!val) { div.innerHTML = '<i class="fa-solid fa-cube"></i>'; return; }
            if (val.startsWith('http')) {
                div.innerHTML = `<img src="${val}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;">`;
            } else {
                div.innerHTML = `<i class="${val}"></i>`;
            }
        }

        // --- Extra Buttons Logic ---
        function addExtraBtn(data = null) {
            const tpl = document.getElementById('tplBtnItem');
            const clone = tpl.content.cloneNode(true);
            const root = clone.querySelector('.btn-config-item');
            
            if (data) {
                root.querySelector('.btn-label').value = data.label;
                root.querySelector('.btn-icon').value = data.icon;
                root.querySelector('.btn-type').value = data.type;
                root.querySelector('.btn-content').value = data.content;
            }
            
            // Trigger type change to set label
            toggleBtnContent(root.querySelector('.btn-type'));
            
            document.getElementById('extraBtnList').appendChild(root);
        }

        function removeExtraBtn(el) {
            el.closest('.btn-config-item').remove();
        }

        function toggleBtnContent(select) {
            const root = select.closest('.btn-config-item');
            const label = root.querySelector('.content-label');
            const area = root.querySelector('.btn-content');
            
            if (select.value === 'link') {
                label.innerText = '链接地址 (URL)';
                area.placeholder = 'https://example.com';
            } else if (select.value === 'text') {
                label.innerText = '弹窗内容 (Markdown)';
                area.placeholder = '## 标题\n- 列表项\n**加粗文字**';
            } else {
                label.innerText = '图片地址 (URL)';
                area.placeholder = 'https://example.com/image.png';
            }
        }

        function getExtraButtonsData() {
            const items = document.querySelectorAll('.btn-config-item');
            const data = [];
            items.forEach(item => {
                data.push({
                    label: item.querySelector('.btn-label').value,
                    icon: item.querySelector('.btn-icon').value,
                    type: item.querySelector('.btn-type').value,
                    content: item.querySelector('.btn-content').value
                });
            });
            return JSON.stringify(data);
        }

        // --- Submit ---
        async function submitForm() {
            const btn = document.querySelector('button[onclick="submitForm()"]');
            const originalText = btn.innerText;
            btn.innerText = '保存中...';
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('folderName', document.getElementById('f_folderName').value);
                formData.append('projectName', document.getElementById('f_projectName').value);
                formData.append('isPublic', document.getElementById('f_isPublic').checked);
                formData.append('isEncrypted', document.getElementById('f_isEncrypted').checked);
                
                const pwd = document.getElementById('f_passwords').value;
                if (pwd) formData.append('passwords', pwd); // Only send if user typed something
                // Note: If user clears passwords, we need to handle that. 
                // But for now let's assume typing nothing means "no change" if editing.
                // A better way is to always send, but fetch current passwords first if editing.
                // Given the limitations, let's just send it. If empty, it overrides to empty (no password).
                // Wait, if I am editing and I leave it blank, I might want to keep old password.
                // But I can't see old password. This is a common UX dilemma in simple admins.
                // Let's just send what is there. If empty, it becomes empty.
                
                formData.append('rememberDays', document.getElementById('f_rememberDays').value);
                formData.append('iconUrl', document.getElementById('f_iconUrl').value);
                formData.append('extraButtons', getExtraButtonsData());
                
                const files = document.getElementById('f_files').files;
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                if (data.success) {
                    showToast('保存成功');
                    loadProjects(currentPage);
                    if (!currentFolder) initCreate(); // If was create, reset
                } else {
                    alert('保存失败: ' + (data.message || '未知错误'));
                }
            } catch(e) {
                console.error(e);
                alert('请求出错');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteProject() {
            if (!confirm(`确定要删除项目 "${currentFolder}" 吗？\n此操作不可恢复！`)) return;
            
            try {
                const res = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ folderName: currentFolder })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('删除成功');
                    initCreate();
                    loadProjects();
                } else {
                    alert('删除失败');
                }
            } catch(e) { alert('请求出错'); }
        }

        function showToast(msg) {
            const div = document.createElement('div');
            div.className = 'toast';
            div.innerText = msg;
            document.getElementById('toastContainer').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
    <div id="toastContainer" class="toast-container"></div>
</body>
</html>
