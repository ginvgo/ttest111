<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目展示</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Index Specific Styles */
        .markdown-body { box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; padding: 15px; }
        .empty-result { text-align: center; padding: 3rem; color: var(--text-muted); }
        
        /* Modal Enhanced */
        .modal-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; background: #f8fafc; padding: 0.5rem; border-radius: 4px; }
        
        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; padding-bottom: 2rem; }
        .page-btn { padding: 0.5rem 1rem; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .page-btn:hover { border-color: var(--primary); color: var(--primary); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="brand"><i class="fa-solid fa-rocket"></i> 项目展示中心</a>
        
        <div class="search-box">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="搜索项目..." onkeydown="handleSearch(event)">
            <i class="fa-solid fa-times-circle" id="clearSearch" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--text-muted); display:none;" onclick="clearSearch()"></i>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Search Stats -->
        <div id="searchStats" class="hidden" style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
            找到 <span id="totalResults" style="font-weight:700; color:var(--text-main);">0</span> 个相关项目
        </div>

        <div id="projectGrid" class="project-grid">
            <!-- Cards injected here -->
        </div>

        <div id="pagination" class="pagination"></div>
    </div>

    <!-- Password Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="authTitle">访问受限</h3>
            <div class="modal-subtitle">
                <i class="fa-solid fa-info-circle"></i> 
                此项目已加密。请联系管理员获取访问密码。
            </div>
            
            <div class="form-group">
                <label>访问密码</label>
                <div class="password-wrapper">
                    <input type="password" id="authPassword" class="form-input" placeholder="请输入密码">
                    <i class="fa-solid fa-eye password-toggle" onclick="togglePassword('authPassword')"></i>
                </div>
                <div id="authError" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem; display: none;">密码错误</div>
            </div>

            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" id="rememberMe"> 
                    <span style="font-size: 0.9rem;">记住密码 (<span id="rememberDaysDisplay">30</span>天免登)</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeAuthModal()">取消</button>
                <button class="btn btn-primary" onclick="submitAuth()">验证访问</button>
            </div>
        </div>
    </div>

    <!-- Extra Content Modal (Markdown) -->
    <div id="contentModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px; width: 95%;">
            <h3 class="modal-title" id="contentTitle">详细信息</h3>
            <div id="contentBody" class="markdown-body" style="max-height: 60vh; overflow-y: auto;"></div>
            <div class="modal-actions" style="margin-top: 1rem;">
                <button class="btn btn-primary" onclick="document.getElementById('contentModal').classList.remove('active')">关闭</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentSearch = '';
        let currentAuthFolder = null;
        let currentAuthUrl = null;

        // --- Init ---
        window.onload = () => {
            loadProjects(1);
            checkRedirect();
        };

        // --- Data Loading ---
        async function loadProjects(page = 1) {
            currentPage = page;
            const container = document.getElementById('projectGrid');
            const stats = document.getElementById('searchStats');
            
            // Show loading state if needed, or skeleton
            
            try {
                const url = `/api/list?page=${page}&search=${encodeURIComponent(currentSearch)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                // Update Stats
                if (currentSearch) {
                    stats.classList.remove('hidden');
                    document.getElementById('totalResults').innerText = data.total;
                } else {
                    stats.classList.add('hidden');
                }

                // Render Grid
                container.innerHTML = '';
                if (data.items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-result" style="grid-column: 1/-1;">
                            <i class="fa-solid fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.2;"></i>
                            <p>没有找到相关项目</p>
                        </div>
                    `;
                } else {
                    data.items.forEach(p => renderCard(p, container));
                }

                // Render Pagination
                renderPagination(data.page, data.totalPages);

            } catch(e) {
                console.error(e);
            }
        }

        function renderCard(p, container) {
            const card = document.createElement('div');
            card.className = 'project-card';
            
            // Icon
            let iconHtml = '';
            if (p.icon_url && p.icon_url.startsWith('http')) {
                iconHtml = `<img src="${p.icon_url}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
            } else {
                iconHtml = `<i class="${p.icon_url || 'fa-solid fa-folder'}" style="font-size: 1.5rem;"></i>`;
            }

            // Extra Buttons
            let extraBtnsHtml = '';
            try {
                const btns = JSON.parse(p.extra_buttons || '[]');
                if (btns.length > 0) {
                    extraBtnsHtml = '<div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">';
                    btns.forEach(b => {
                        if (b.type === 'link') {
                            extraBtnsHtml += `<a href="${b.content}" target="_blank" class="btn btn-sm btn-outline">${b.name}</a>`;
                        } else {
                            // Text Popup
                            // Use encodeURIComponent to safely pass content
                            const safeContent = encodeURIComponent(b.content);
                            extraBtnsHtml += `<button class="btn btn-sm btn-outline" onclick="showContentModal('${b.name}', '${safeContent}')">${b.name}</button>`;
                        }
                    });
                    extraBtnsHtml += '</div>';
                }
            } catch(e) {}

            card.innerHTML = `
                <div class="card-icon ${p.is_encrypted ? 'locked' : ''}">
                    ${iconHtml}
                </div>
                <div class="card-title">
                    ${p.project_name} 
                    ${p.is_encrypted ? '<i class="fa-solid fa-lock" style="font-size:0.8rem; color:#ef4444; margin-left:5px;"></i>' : ''}
                </div>
                <div class="card-meta">
                    ${extraBtnsHtml}
                </div>
                <div class="card-actions">
                    ${getActionButton(p)}
                </div>
            `;
            container.appendChild(card);
        }

        function getActionButton(p) {
            const url = `/projects/${p.folder_name}/index.html`;
            if (p.is_encrypted) {
                return `<button class="btn btn-primary" style="width:100%" onclick="handleAuth('${p.folder_name}', '${p.project_name}', ${p.remember_days}, '${url}')">
                            <i class="fa-solid fa-lock"></i> 私密访问
                        </button>`;
            } else {
                return `<a href="${url}" target="_blank" class="btn btn-primary" style="width:100%">
                            <i class="fa-solid fa-external-link-alt"></i> 立即访问
                        </a>`;
            }
        }

        function renderPagination(current, total) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            if (total <= 1) return;

            // Prev
            const prev = document.createElement('button');
            prev.className = 'page-btn';
            prev.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            prev.disabled = current === 1;
            prev.onclick = () => loadProjects(current - 1);
            container.appendChild(prev);

            // Numbers (Simple logic for now)
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - 1 && i <= current + 1)) {
                    const btn = document.createElement('button');
                    btn.className = `page-btn ${i === current ? 'active' : ''}`;
                    btn.innerText = i;
                    btn.onclick = () => loadProjects(i);
                    container.appendChild(btn);
                } else if (i === current - 2 || i === current + 2) {
                    const span = document.createElement('span');
                    span.innerText = '...';
                    span.style.padding = '0.5rem';
                    container.appendChild(span);
                }
            }

            // Next
            const next = document.createElement('button');
            next.className = 'page-btn';
            next.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
            next.disabled = current === total;
            next.onclick = () => loadProjects(current + 1);
            container.appendChild(next);
        }

        // --- Search Logic ---
        function handleSearch(e) {
            if (e.key === 'Enter') {
                const val = e.target.value.trim();
                currentSearch = val;
                document.getElementById('clearSearch').style.display = val ? 'block' : 'none';
                loadProjects(1);
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            currentSearch = '';
            loadProjects(1);
        }

        // --- Auth Logic ---
        function handleAuth(folderName, projectName, days, url) {
            currentAuthFolder = folderName;
            currentAuthUrl = url;
            
            document.getElementById('authTitle').innerText = projectName;
            document.getElementById('rememberDaysDisplay').innerText = days || 30;
            document.getElementById('authPassword').value = '';
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            currentAuthFolder = null;
        }

        async function submitAuth() {
            const pwd = document.getElementById('authPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            
            if (!pwd) return;

            try {
                const res = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        folderName: currentAuthFolder,
                        password: pwd,
                        rememberMe: remember
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    window.location.href = currentAuthUrl;
                } else {
                    document.getElementById('authError').style.display = 'block';
                }
            } catch(e) {
                alert('验证出错');
            }
        }

        function togglePassword(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        // --- Markdown Content Modal ---
        function showContentModal(title, encodedContent) {
            const content = decodeURIComponent(encodedContent);
            document.getElementById('contentTitle').innerText = title;
            document.getElementById('contentBody').innerHTML = marked.parse(content);
            document.getElementById('contentModal').classList.add('active');
        }

        // --- Redirect Check ---
        function checkRedirect() {
            const params = new URLSearchParams(window.location.search);
            const denied = params.get('denied');
            
            if (denied && denied !== '1') {
                fetchProjectInfo(denied);
            } else if (denied === '1') {
                const folder = params.get('project');
                if (folder) fetchProjectInfo(folder);
            }
        }

        async function fetchProjectInfo(folderName) {
            // We need an API to get single project info or search for it
            // Reuse list API
            const res = await fetch(`/api/list?search=${folderName}`);
            const data = await res.json();
            const project = data.items.find(p => p.folder_name === folderName);
            if (project) {
                handleAuth(project.folder_name, project.project_name, project.remember_days, `/projects/${folderName}/index.html`);
                document.getElementById('authError').innerText = "请先验证密码";
                document.getElementById('authError').style.display = 'block';
            }
        }
    </script>
</body>
</html>
