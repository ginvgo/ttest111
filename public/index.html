<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Portfolio</title>
    <link rel="stylesheet" href="style.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown support -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Professional Search Bar */
        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            padding-left: 3rem;
            border-radius: 50px;
            border: 1px solid #e2e8f0;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            font-size: 1rem;
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            /* width: 1.2rem; height: 1.2rem; Remove fixed size for FontAwesome */
            font-size: 1.2rem;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 3rem;
            padding-bottom: 3rem;
        }
        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
        }
        .page-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Project Card Enhancements */
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #f1f5f9;
            height: 100%;
            position: relative;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #e2e8f0;
        }
        .card-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border-radius: 10px;
            color: var(--primary);
            font-size: 1.5rem;
            transition: all 0.3s;
        }
        .card-icon.locked {
            background: #fef2f2;
            color: #ef4444;
        }
        .card-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .project-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .project-id {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 1rem;
            display: none; /* Hide ID as requested */
        }
        
        /* Buttons Area */
        .card-footer {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-visit {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.6rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
            gap: 8px;
        }
        .btn-visit:hover {
            background: #1d4ed8;
        }
        .btn-visit.locked-btn {
            background: #ef4444;
        }
        .btn-visit.locked-btn:hover {
            background: #dc2626;
        }

        /* Extra Buttons */
        .extra-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 6px 10px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #0f172a;
        }
        
        /* Modal Content Styles */
        .popup-content-img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        .popup-content-text {
            line-height: 1.6;
            color: #334155;
            text-align: left;
            padding: 0.5rem;
        }
        .popup-content-text h1, .popup-content-text h2, .popup-content-text h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #0f172a;
        }
        .popup-content-text p {
            margin-bottom: 1em;
        }
        .popup-content-text ul, .popup-content-text ol {
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .popup-content-text code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .popup-content-text pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        /* Password Toggle */
        .password-wrapper {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            cursor: pointer;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">MyLab</a>
        <div class="nav-links">
            <a href="https://github.com/yourname" target="_blank">GitHub</a>
        </div>
    </nav>

    <div class="container">
        <header style="text-align: center; margin: 4rem 0 2rem;">
            <h1 style="margin-bottom: 2rem; color: #0f172a;">Discover Projects</h1>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search projects by name or ID..." oninput="debounceSearch()">
            </div>
            <div id="searchStats" style="margin-top: 1rem; color: #64748b; font-size: 0.9rem; min-height: 1.5rem;"></div>
        </header>

        <main id="project-list" class="project-grid">
            <!-- Dynamic Content -->
        </main>

        <div id="pagination" class="pagination"></div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-box">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <h3 id="modalProjectName" style="font-size: 1.5rem; color: #1e293b; margin-bottom: 0.5rem;">Protected Project</h3>
                <p style="color:#64748b; font-size:0.9rem;">
                    此项目为加密项目，需要密码访问。<br>
                    <span style="font-size: 0.8rem; opacity: 0.8;">(可通过联系管理员或关注公众号获取密码)</span>
                </p>
            </div>
            
            <div class="form-group">
                <div class="password-wrapper">
                    <input type="password" id="accessPassword" class="form-input" placeholder="请输入访问密码" onkeypress="if(event.key==='Enter') verifyPassword()">
                    <span class="password-toggle" onclick="togglePwdVisibility('accessPassword', this)">
                        <i class="fa-regular fa-eye"></i>
                    </span>
                </div>
                <div style="margin-top: 10px; display: flex; align-items: center; justify-content: space-between;">
                    <label style="font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; color: #64748b;">
                        <input type="checkbox" id="chkRemember" style="margin-right: 5px;"> 
                        <span id="rememberLabel">记住密码</span>
                    </label>
                </div>
                <div id="pwdError" style="color:#ef4444; font-size:0.85rem; display:none; margin-top:8px;">密码错误，请重试</div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:1.5rem;">
                <button onclick="closeModal()" class="btn btn-outline" style="flex:1;">取消</button>
                <button onclick="verifyPassword()" class="btn btn-primary" style="flex:1;">立即访问</button>
            </div>
        </div>
    </div>

    <!-- Content Popup Modal -->
    <div id="contentModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 800px; width: 90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 id="contentModalTitle" style="font-size: 1.25rem; color: #1e293b; margin:0;">信息</h3>
                <span onclick="closeContentModal()" style="cursor:pointer; color:#94a3b8; font-size:1.5rem;">&times;</span>
            </div>
            <div id="contentModalBody" style="text-align:center;">
                <!-- Content -->
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let currentPage = 1;
        let searchTimer = null;

        // Init
        loadProjects(1);

        function togglePwdVisibility(id, btn) {
            const input = document.getElementById(id);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fa-regular fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fa-regular fa-eye';
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                currentPage = 1;
                loadProjects(1);
            }, 300);
        }

        async function loadProjects(page) {
            currentPage = page;
            const search = document.getElementById('searchInput').value;
            const listEl = document.getElementById('project-list');
            const statsEl = document.getElementById('searchStats');
            const pagEl = document.getElementById('pagination');

            listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#94a3b8;">Loading...</div>';
            
            try {
                // Add timestamp to prevent caching
                const t = new Date().getTime();
                const res = await fetch(`/api/list?page=${page}&search=${encodeURIComponent(search)}&t=${t}`);
                const data = await res.json();
                
                // Update Stats
                statsEl.innerText = search ? `Found ${data.total} results` : '';

                // Render List
                if (data.items.length === 0) {
                    listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#94a3b8;">No projects found.</div>';
                } else {
                    listEl.innerHTML = data.items.map(item => {
                        // Icon Logic
                        let iconHtml = '';
                        if (item.icon_url) {
                            if (item.icon_url.startsWith('fa-')) {
                                iconHtml = `<i class="${item.icon_url}"></i>`;
                            } else {
                                iconHtml = `<img src="${item.icon_url}" style="width:100%; height:100%; object-fit:contain; border-radius:4px;">`;
                            }
                        } else {
                            // Default icon
                            iconHtml = item.is_encrypted 
                                ? '<i class="fa-solid fa-lock"></i>' 
                                : '<i class="fa-solid fa-cube"></i>';
                        }

                        // Extra Buttons Logic
                        let buttonsHtml = '';
                        if (item.extra_buttons) {
                            try {
                                const buttons = JSON.parse(item.extra_buttons);
                                if (Array.isArray(buttons) && buttons.length > 0) {
                                    buttonsHtml = '<div class="extra-actions">';
                                    buttonsHtml += buttons.map((btn, idx) => `
                                        <button class="action-btn" onclick="showContentModal('${encodeURIComponent(btn.label)}', '${btn.type}', '${encodeURIComponent(btn.content)}')">
                                            <i class="fa-solid fa-circle-info"></i> ${btn.label}
                                        </button>
                                    `).join('');
                                    buttonsHtml += '</div>';
                                }
                            } catch(e) {}
                        }

                        // Visit Button Logic
                        const visitBtn = `
                            <button class="btn-visit ${item.is_encrypted ? 'locked-btn' : ''}" onclick="handleAccess('${item.folder_name}', ${item.is_encrypted}, '${item.project_name || item.folder_name}', ${item.remember_days || 30})">
                                ${item.is_encrypted ? '<i class="fa-solid fa-lock"></i> 私密访问' : '<i class="fa-solid fa-rocket"></i> 立即访问'}
                            </button>
                        `;

                        return `
                        <article class="project-card">
                            <div class="card-icon ${item.is_encrypted ? 'locked' : ''}">
                                ${iconHtml}
                            </div>
                            <h3 class="project-name">${item.project_name || item.folder_name}</h3>
                            <div class="project-id">ID: ${item.folder_name}</div>
                            <div class="card-meta">
                                ${item.is_encrypted ? 'Private Access' : 'Public Project'}
                            </div>
                            <div class="card-footer">
                                ${visitBtn}
                                ${buttonsHtml}
                            </div>
                        </article>
                    `}).join('');
                }

                // Render Pagination
                renderPagination(data.page, data.totalPages);

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">Error loading projects.</div>';
            }
        }
        
        // Content Modal Logic
        function showContentModal(label, type, content) {
            label = decodeURIComponent(label);
            content = decodeURIComponent(content);
            document.getElementById('contentModalTitle').innerText = label;
            const body = document.getElementById('contentModalBody');
            
            if (type === 'image') {
                body.innerHTML = `<img src="${content}" class="popup-content-img" alt="${label}">`;
            } else {
                body.innerHTML = `<div class="popup-content-text markdown-body">${marked.parse(content)}</div>`;
            }
            
            document.getElementById('contentModal').classList.add('active');
        }

        function closeContentModal() {
            document.getElementById('contentModal').classList.remove('active');
        }

        // Access Modal
        let currentFolder = '';
        function handleAccess(folder, isEncrypted, name, rememberDays) {
            if (!isEncrypted) {
                window.open(`/${folder}/`, '_blank');
                return;
            }

            currentFolder = folder;
            document.getElementById('modalProjectName').innerText = `访问: ${name}`;
            document.getElementById('accessPassword').value = '';
            document.getElementById('pwdError').style.display = 'none';
            document.getElementById('chkRemember').checked = false;
            
            const days = rememberDays || 30;
            document.getElementById('rememberLabel').innerText = `记住密码 (${days}天免登)`;

            document.getElementById('passwordModal').classList.add('active');
            setTimeout(() => document.getElementById('accessPassword').focus(), 100);
        }
        
        // Close content modal when clicking outside
        document.getElementById('contentModal').addEventListener('click', (e) => {
            if (e.target.id === 'contentModal') closeContentModal();
        });

        function renderPagination(current, total) {
            const el = document.getElementById('pagination');
            if (total <= 1) {
                el.innerHTML = '';
                return;
            }

            let html = '';
            // Prev
            html += `<button class="page-btn" ${current === 1 ? 'disabled' : ''} onclick="loadProjects(${current - 1})">Prev</button>`;
            
            // Numbers (Simple implementation)
            for (let i = 1; i <= total; i++) {
                if (i === 1 || i === total || (i >= current - 1 && i <= current + 1)) {
                    html += `<button class="page-btn ${i === current ? 'active' : ''}" onclick="loadProjects(${i})">${i}</button>`;
                } else if (i === current - 2 || i === current + 2) {
                    html += `<span style="padding:0.5rem;">...</span>`;
                }
            }

            // Next
            html += `<button class="page-btn" ${current === total ? 'disabled' : ''} onclick="loadProjects(${current + 1})">Next</button>`;
            
            el.innerHTML = html;
        }

        // Override handleAccess to support name
        // The original handleAccess is in main.js, we can override or pass params
        // But main.js functions are global.
        // I will update main.js to accept name, but for now I pass it here.
    </script>
</body>
</html>
