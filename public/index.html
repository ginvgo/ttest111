<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Hub</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* æœç´¢ä¸‹æ‹‰ */
        .search-wrapper { position: relative; max-width: 400px; width: 100%; }
        .search-results-popover {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: white; border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 50;
            display: none; padding: 0.5rem 0; margin-top: 5px; max-height: 300px; overflow-y: auto;
        }
        .search-item { padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #f8fafc; color: var(--primary); }
        
        /* åˆ†é¡µå™¨ */
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 3rem; margin-bottom: 2rem; }
        .page-btn { padding: 6px 14px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:hover:not(.active) { background: #f8fafc; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">ProjectHub</a>
        
        <div class="search-wrapper">
            <div class="search-box">
                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="å…¨å±€æœç´¢é¡¹ç›®..." autocomplete="off">
                <button id="clearSearch" onclick="clearSearch()" style="display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:#999;">âœ•</button>
            </div>
            <div id="searchPopover" class="search-results-popover"></div>
        </div>

        <div class="nav-links">
            <a href="https://github.com/yourname" target="_blank">GitHub</a>
        </div>
    </nav>

    <div class="container">
        <header style="text-align: center; margin: 4rem 0;">
            <h1>Project Portfolio</h1>
            <p style="color: var(--text-muted);">Innovation & Code</p>
        </header>

        <main id="project-list" class="project-grid">
            <!-- PROJECT_LIST_START -->
            <!-- åˆ—è¡¨ç”±åç«¯ç”Ÿæˆ -->
            <!-- PROJECT_LIST_END -->
        </main>
        
        <div id="pagination" class="pagination"></div>
    </div>

    <!-- å¢å¼ºç‰ˆå¯†ç  Modal -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-box">
            <div style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ”’</div>
                <h3 id="modalTitle" style="font-size: 1.25rem; margin-bottom: 0.5rem; color:#1e293b;">é¡¹ç›®åç§°</h3>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; background: #f8fafc; padding: 10px; border-radius: 6px;">
                    è®¿é—®æ­¤é¡¹ç›®éœ€è¦æˆæƒã€‚<br>
                    <span style="font-size: 0.8rem; color: #475569;">æç¤ºï¼šè¯·æŸ¥çœ‹ç½®é¡¶å¸–æˆ–è”ç³»ç®¡ç†å‘˜è·å–</span>
                </div>
            </div>
            
            <div class="form-group">
                <input type="password" id="accessPassword" class="form-input" placeholder="è¾“å…¥è®¿é—®å¯†ç ..." onkeydown="if(event.key==='Enter') verifyPassword()">
                <div style="margin-top: 10px; display: flex; justify-content: space-between; font-size: 0.85rem;">
                    <label style="cursor: pointer; display: flex; align-items: center; user-select: none;">
                        <input type="checkbox" id="chkRemember" style="margin-right: 5px;"> 
                        <!-- åŠ¨æ€æ˜¾ç¤ºçš„æ–‡æœ¬ -->
                        <span id="rememberText">å…å¯†ç™»å½•</span>
                    </label>
                </div>
                <div id="pwdError" style="color: #ef4444; font-size: 0.85rem; margin-top: 5px; display: none;">å¯†ç é”™è¯¯</div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="closeModal()" class="btn btn-outline" style="flex: 1;">å–æ¶ˆ</button>
                <button onclick="verifyPassword()" class="btn btn-primary" style="flex: 1;">éªŒè¯è¿›å…¥</button>
            </div>
        </div>
    </div>
    
    <!-- çŸ¥è¯†æ˜Ÿçƒ Modal -->
    <div id="planetModal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <div style="font-size: 3rem;">ğŸª</div><h3>çŸ¥è¯†æ˜Ÿçƒ</h3><p>è·å–æºç ä¸æŠ€æœ¯æ”¯æŒ</p><button onclick="document.getElementById('planetModal').classList.remove('active')" class="btn btn-primary">å…³é—­</button>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let allCards = [];
        let currentPage = 1;
        let pageSize = 12; // é»˜è®¤å€¼

        window.onload = async function() {
            // 1. ä¼˜å…ˆè·å–å…¨å±€åˆ†é¡µè®¾ç½®
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                if(data.pageSize) pageSize = data.pageSize;
            } catch(e) { console.error('Failed to load settings'); }

            allCards = Array.from(document.querySelectorAll('.project-card'));
            
            // 2. æ£€æŸ¥URLè·³è½¬é€»è¾‘ (å®ˆé—¨å‘˜)
            const params = new URLSearchParams(window.location.search);
            const target = params.get('target');
            if (target) {
                if (getCookie(`access_${target}`) === 'ok') {
                    // å·²æœ‰æƒé™ï¼Œæ¸…é™¤å‚æ•°
                     window.history.replaceState({}, document.title, "/");
                } else {
                    // æ— æƒé™ï¼Œå¼¹çª—
                    const card = allCards.find(c => c.dataset.name.includes(target.toLowerCase()));
                    const title = card ? card.querySelector('.card-title').innerText : target;
                    // ä¼ é€’ null è§¦å‘ DOM æŸ¥æ‰¾ days
                    handleAccess(target, true, title);
                    window.history.replaceState({}, document.title, "/");
                }
            }

            renderPage(1);
        };

        function renderPage(page) {
            currentPage = page;
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            
            allCards.forEach(c => c.style.display = 'none');
            
            // æœç´¢ä¸­ä¸åˆ†é¡µ
            if(document.getElementById('searchInput').value) return;

            const pageItems = allCards.slice(start, end);
            pageItems.forEach(c => c.style.display = 'flex');
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(allCards.length / pageSize);
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.innerText = i;
                btn.onclick = () => renderPage(i);
                container.appendChild(btn);
            }
        }

        const searchInput = document.getElementById('searchInput');
        const popover = document.getElementById('searchPopover');
        const clearBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            clearBtn.style.display = val ? 'block' : 'none';
            if (!val) {
                popover.style.display = 'none';
                renderPage(1);
                return;
            }
            const matched = allCards.filter(c => c.dataset.name.includes(val));
            allCards.forEach(c => c.style.display = 'none');
            matched.forEach(c => c.style.display = 'flex');
            document.getElementById('pagination').innerHTML = ''; 

            popover.innerHTML = '';
            popover.style.display = 'block';
            if (matched.length > 0) {
                matched.slice(0, 5).forEach(c => {
                    const title = c.querySelector('.card-title').innerText;
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `<span>${title}</span> <span style="font-size:0.8rem;color:#999;">GO &rarr;</span>`;
                    div.onclick = () => c.querySelector('button, a').click();
                    popover.appendChild(div);
                });
            } else {
                popover.innerHTML = '<div class="search-item" style="justify-content:center; color:#999;">æ— åŒ¹é…é¡¹ç›®</div>';
            }
        });

        function clearSearch() {
            searchInput.value = '';
            popover.style.display = 'none';
            clearBtn.style.display = 'none';
            renderPage(1);
        }

        function getCookie(name) {
            const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }

        function handleAccess(folder, isLocked, titleOverride) {
            if (!isLocked) {
                window.location.href = `/projects/${folder}/index.html`;
                return;
            }
            if (getCookie(`access_${folder}`) === 'ok') {
                window.location.href = `/projects/${folder}/index.html`;
                return;
            }

            window.currentFolder = folder;
            let title = titleOverride;
            let days = 30; // é»˜è®¤å€¼

            // å°è¯•ä» DOM è·å–æ•°æ®
            const card = document.querySelector(`.project-card[data-name*="${folder.toLowerCase()}"]`);
            if (card) {
                if(!title) title = card.querySelector('.card-title').innerText;
                // è·å–åç«¯å†™å…¥çš„è®°ä½å¤©æ•°
                const d = card.getAttribute('data-days');
                if(d) days = parseInt(d);
            }

            document.getElementById('modalTitle').innerText = title || folder;
            // è”åŠ¨æ›´æ–°æ–‡æœ¬
            document.getElementById('rememberText').innerText = `${days}å¤©å…å¯†ç™»å½•`;
            
            document.getElementById('accessPassword').value = '';
            document.getElementById('pwdError').style.display = 'none';
            closeModal();
            document.getElementById('passwordModal').classList.add('active');
        }

        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.remove('active')); }
        function showPlanetInfo() { document.getElementById('planetModal').classList.add('active'); }

        async function verifyPassword() {
            const password = document.getElementById('accessPassword').value;
            const remember = document.getElementById('chkRemember').checked;
            
            const res = await fetch('/api/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folderName: window.currentFolder, password, remember })
            });

            const data = await res.json();
            if (data.success) {
                const box = document.querySelector('#passwordModal .modal-box');
                box.innerHTML = '<div style="text-align:center; padding:2rem;"><h3 style="color:#22c55e;">éªŒè¯é€šè¿‡</h3><p>æ­£åœ¨è¿›å…¥...</p></div>';
                setTimeout(() => {
                    window.location.href = `/projects/${window.currentFolder}/index.html`;
                }, 1000);
            } else {
                document.getElementById('pwdError').style.display = 'block';
            }
        }
    </script>
</body>
</html>
